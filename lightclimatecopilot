blueprint:
  name: Bevegelse-lys med 6 tidsvinduer (respekterer manuell dimming)
  description: >
    Slår på dimmerlys ved bevegelse med 6 tidsvinduer for brightness. Setter brightness kun når lyset er AV,
    slik at manuell dimming respekteres til lyset har vært av igjen. Felles av-forsinkelse.
  domain: automation

  input:
    motion_sensor:
      name: Bevegelsessensor
      description: Motion/binary_sensor som blir 'on' ved bevegelse
      selector:
        entity:
          domain: binary_sensor
          device_class: motion

    light_entity:
      name: Lys (dimmer)
      description: Velg lysentitet eller lysgruppe
      selector:
        entity:
          domain: light

    off_delay_minutes:
      name: Av-forsinkelse (minutter)
      description: Hvor lenge uten bevegelse før lyset slås av
      default: 5
      selector:
        number:
          min: 1
          max: 180
          step: 1
          mode: slider

    transition_seconds:
      name: Transition (sekunder)
      description: Myk overgang ved på/av
      default: 0
      selector:
        number:
          min: 0
          max: 10
          step: 1
          mode: slider

    # 6 tidsvinduer: start, slutt, brightness (0-100)
    t1_start:
      name: Tidsvindu 1 - start
      selector: { time: {} }
    t1_end:
      name: Tidsvindu 1 - slutt
      selector: { time: {} }
    t1_brightness:
      name: Tidsvindu 1 - brightness (0-100)
      default: 20
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    t2_start:
      name: Tidsvindu 2 - start
      selector: { time: {} }
    t2_end:
      name: Tidsvindu 2 - slutt
      selector: { time: {} }
    t2_brightness:
      name: Tidsvindu 2 - brightness (0-100)
      default: 30
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    t3_start:
      name: Tidsvindu 3 - start
      selector: { time: {} }
    t3_end:
      name: Tidsvindu 3 - slutt
      selector: { time: {} }
    t3_brightness:
      name: Tidsvindu 3 - brightness (0-100)
      default: 40
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    t4_start:
      name: Tidsvindu 4 - start
      selector: { time: {} }
    t4_end:
      name: Tidsvindu 4 - slutt
      selector: { time: {} }
    t4_brightness:
      name: Tidsvindu 4 - brightness (0-100)
      default: 50
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    t5_start:
      name: Tidsvindu 5 - start
      selector: { time: {} }
    t5_end:
      name: Tidsvindu 5 - slutt
      selector: { time: {} }
    t5_brightness:
      name: Tidsvindu 5 - brightness (0-100)
      default: 60
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    t6_start:
      name: Tidsvindu 6 - start
      selector: { time: {} }
    t6_end:
      name: Tidsvindu 6 - slutt
      selector: { time: {} }
    t6_brightness:
      name: Tidsvindu 6 - brightness (0-100)
      default: 70
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

mode: parallel
max: 10

variables:
  # Lys tidsvinduer og brightness
  t1_start: !input t1_start
  t1_end: !input t1_end
  t1_pct: !input t1_brightness
  t2_start: !input t2_start
  t2_end: !input t2_end
  t2_pct: !input t2_brightness
  t3_start: !input t3_start
  t3_end: !input t3_end
  t3_pct: !input t3_brightness
  t4_start: !input t4_start
  t4_end: !input t4_end
  t4_pct: !input t4_brightness
  t5_start: !input t5_start
  t5_end: !input t5_end
  t5_pct: !input t5_brightness
  t6_start: !input t6_start
  t6_end: !input t6_end
  t6_pct: !input t6_brightness

  # Finn aktivt tidsvindu og ønsket brightness
  active_pct: >
    {% macro between(s,e,n) -%}
      {%- set s = strptime(s, '%H:%M:%S').time() -%}
      {%- set e = strptime(e, '%H:%M:%S').time() -%}
      {%- if s <= e -%}
        {{ (n >= s and n < e) }}
      {%- else -%}
        {{ (n >= s or n < e) }}
      {%- endif -%}
    {%- endmacro %}
    {%- set n = now().time() -%}
    {%- if between(t1_start, t1_end, n) -%}
      {{ t1_pct }}
    {%- elif between(t2_start, t2_end, n) -%}
      {{ t2_pct }}
    {%- elif between(t3_start, t3_end, n) -%}
      {{ t3_pct }}
    {%- elif between(t4_start, t4_end, n) -%}
      {{ t4_pct }}
    {%- elif between(t5_start, t5_end, n) -%}
      {{ t5_pct }}
    {%- elif between(t6_start, t6_end, n) -%}
      {{ t6_pct }}
    {%- else -%}
      {{ t1_pct }}
    {%- endif -%}

trigger:
  - id: motion_on
    platform: state
    entity_id: !input motion_sensor
    to: "on"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: motion_on
        sequence:
          # Sett lys kun hvis det er AV, så manuell dimming respekteres
          - if:
              - condition: state
                entity_id: !input light_entity
                state: "off"
            then:
              - service: light.turn_on
                target:
                  entity_id: !input light_entity
                data:
                  brightness_pct: "{{ active_pct | int }}"
                  transition: !input transition_seconds

          # Vent på inaktivitet (fornyes ved ny bevegelse pga ny kjøring)
          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensor
                to: "off"
                for:
                  minutes: !input off_delay_minutes

          # Slå av lys
          - service          - service: light.turn_off
            target:
              entity_id: !input light_entity
            data:
